# GraphQL

> åŸæ–‡ï¼š[https://docs.gitlab.com/ee/development/fe_guide/graphql.html](https://docs.gitlab.com/ee/development/fe_guide/graphql.html)

*   [Getting Started](#getting-started)
    *   [Helpful Resources](#helpful-resources)
    *   [Libraries](#libraries)
    *   [Tooling](#tooling)
        *   [Apollo GraphQL VS Code extension](#apollo-graphql-vs-code-extension)
    *   [Exploring the GraphQL API](#exploring-the-graphql-api)
*   [Apollo Client](#apollo-client)
*   [GraphQL Queries](#graphql-queries)
    *   [Fragments](#fragments)
*   [Usage in Vue](#usage-in-vue)
    *   [Local state with Apollo](#local-state-with-apollo)
        *   [Mocking API response with local Apollo cache](#mocking-api-response-with-local-apollo-cache)
    *   [Using with Vuex](#using-with-vuex)
    *   [Feature flags in queries](#feature-flags-in-queries)
    *   [Manually triggering queries](#manually-triggering-queries)
    *   [Working with pagination](#working-with-pagination)
        *   [Using `fetchMore` method in components](#using-fetchmore-method-in-components)
    *   [Testing](#testing)
        *   [Mocking response as component data](#mocking-response-as-component-data)
        *   [Testing loading state](#testing-loading-state)
        *   [Testing Apollo components](#testing-apollo-components)
*   [Handling errors](#handling-errors)
    *   [Top-level errors](#top-level-errors)
        *   [Handling top-level errors](#handling-top-level-errors)
    *   [Errors-as-data](#errors-as-data)
        *   [Handling errors-as-data](#handling-errors-as-data)
*   [Usage outside of Vue](#usage-outside-of-vue)

# GraphQL[](#graphql "Permalink")

## Getting Started[](#getting-started "Permalink")

### Helpful Resources[](#helpful-resources "Permalink")

**ä¸€èˆ¬èµ„æº**:

*   [ğŸ“š Official Introduction to GraphQL](https://s0graphql0org.icopy.site/learn/)
*   [ğŸ“š Official Introduction to Apollo](https://www.apollographql.com/docs/tutorial/introduction/)

**GitLab ä¸Šçš„ GraphQL**:

*   [ğŸ¬ GitLab Unfiltered GraphQL playlist](https://www.youtube.com/watch?v=wHPKZBDMfxE&list=PL05JrBw4t0KpcjeHjaRMB7IGB2oDWyJzv)
*   [GitLab ä¸Šçš„ GraphQLï¼šæ·±æ½œ](../api_graphql_styleguide.html#deep-dive) ï¼ˆè§†é¢‘ï¼‰ä½œè€… Nick Thomas
    *   GitLab ä¸Š GraphQL çš„å†å²æ¦‚è¿°ï¼ˆä¸æ˜¯ç‰¹å®šäºå‰ç«¯çš„ï¼‰
*   [ä½¿ç”¨ GraphQL å’Œ Vue Apollo è¿›è¡Œ GitLab åŠŸèƒ½æ¼”ç»ƒ](https://www.youtube.com/watch?v=6yYp2zB7FrM) ï¼ˆè§†é¢‘ï¼‰ï¼Œä½œè€… Natalia Tepluhina
    *   ä½¿ç”¨ GraphQL åœ¨ GitLab ä¸­å®ç°å‰ç«¯åŠŸèƒ½çš„çœŸå®ç¤ºä¾‹
*   [GitLab ä¸Šçš„å®¢æˆ·ç«¯ GraphQL çš„å†å²](https://www.youtube.com/watch?v=mCKRJxvMnf0) ï¼ˆè§†é¢‘ï¼‰Illya Klymov å’Œ Natalia Tepluhina
*   Natalia Tepluhina [ä» Vuex åˆ° Apollo](https://www.youtube.com/watch?v=9knwu87IfU8) ï¼ˆè§†é¢‘ï¼‰
    *   å…³äºä½•æ—¶é˜¿æ³¢ç½—å¯èƒ½æ¯” Vuex æ›´å¥½çš„é€‰æ‹©ä»¥åŠå¦‚ä½•è¿›è¡Œè¿‡æ¸¡çš„æœ‰ç”¨æ¦‚è¿°
*   [ğŸ›  Vuex -> Apollo Migration: a proof-of-concept project](https://gitlab.com/ntepluhina/vuex-to-apollo/blob/master/README.md)
    *   ä¸€ç³»åˆ—ç¤ºä¾‹å±•ç¤ºäº†ä½¿ç”¨ Vue + GraphQL +ï¼ˆVuex æˆ– Apolloï¼‰åº”ç”¨è¿›è¡ŒçŠ¶æ€ç®¡ç†çš„å¯èƒ½æ–¹æ³•

### Libraries[](#libraries "Permalink")

å½“ä½¿ç”¨ GraphQL è¿›è¡Œå‰ç«¯å¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨[Apollo](https://www.apollographql.com/) ï¼ˆç‰¹åˆ«æ˜¯[Apollo Client](https://www.apollographql.com/docs/react/) ï¼‰å’Œ[Vue Apollo](https://github.com/vuejs/vue-apollo) .

å¦‚æœåœ¨ Vue åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ GraphQLï¼Œåˆ™" Vue ä¸­çš„[ç”¨æ³•"](#usage-in-vue)éƒ¨åˆ†å¯ä»¥å¸®åŠ©æ‚¨å­¦ä¹ å¦‚ä½•é›†æˆ Vue Apollo.

å¯¹äºå…¶ä»–ç”¨ä¾‹ï¼Œè¯·æŸ¥çœ‹[Vue å¤–éƒ¨](#usage-outside-of-vue)çš„[ç”¨æ³•](#usage-outside-of-vue)éƒ¨åˆ†.

### Tooling[](#tooling "Permalink")

*   [Apollo Client Devtools](https://github.com/apollographql/apollo-client-devtools)

#### [Apollo GraphQL VS Code extension](https://marketplace.visualstudio.com/items?itemName=apollographql.vscode-apollo)[](#apollo-graphql-vs-code-extension "Permalink")

å¦‚æœä½¿ç”¨ VS Codeï¼Œåˆ™ Apollo GraphQL æ‰©å±•åæ”¯æŒ`.graphql`æ–‡ä»¶ä¸­çš„è‡ªåŠ¨å®Œæˆ. è‹¥è¦è®¾ç½® GraphQL æ‰©å±•ï¼Œè¯·æŒ‰ç…§ä¸‹åˆ—æ­¥éª¤æ“ä½œï¼š

1.  å°†`apollo.config.js`æ–‡ä»¶æ·»åŠ åˆ°`gitlab`æœ¬åœ°ç›®å½•çš„æ ¹ç›®å½•ä¸­.
2.  ç”¨ä»¥ä¸‹å†…å®¹å¡«å……æ–‡ä»¶ï¼š

    ```
     module.exports = {
       client: {
         includes: ['./app/assets/javascripts/**/*.graphql', './ee/app/assets/javascripts/**/*.graphql'],
         service: {
           name: 'GitLab',
           localSchemaFile: './doc/api/graphql/reference/gitlab_schema.graphql',
         },
       },
     }; 
    ```

3.  é‡æ–°å¯åŠ¨ VS Code.

### Exploring the GraphQL API[](#exploring-the-graphql-api "Permalink")

æˆ‘ä»¬ GraphQL API å¯ä»¥é€šè¿‡ GraphiQL åœ¨æ‚¨çš„å®ä¾‹çš„æ¢ç´¢`/-/graphql-explorer`æˆ–[GitLab.com](https://gitlab.com/-/graphql-explorer) . å¦‚æœ‰éœ€è¦ï¼Œè¯·æŸ¥é˜…ã€Š [GitLab GraphQL API å‚è€ƒã€‹æ–‡æ¡£](../../api/graphql/reference) .

æ‚¨å¯ä»¥åœ¨ GraphiQL çš„**æ–‡æ¡£æµè§ˆå™¨**çš„å³ä¾§æ£€æŸ¥æ‰€æœ‰ç°æœ‰çš„æŸ¥è¯¢å’Œå˜å¼‚. ä¹Ÿå¯ä»¥ç›´æ¥åœ¨å·¦é€‰é¡¹å¡ä¸Šç¼–å†™æŸ¥è¯¢å’Œå˜å¼‚ï¼Œç„¶åå•å‡»å·¦ä¸Šè§’çš„**æ‰§è¡ŒæŸ¥è¯¢**æŒ‰é’®æ¥æ£€æŸ¥å…¶æ‰§è¡Œæƒ…å†µï¼š

[![GraphiQL interface](img/40cd53294c496a4d049d735386c16649.png)](img/graphiql_explorer_v12_4.png)

## Apollo Client[](#apollo-client "Permalink")

ä¸ºäº†ä¿å­˜åœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºä¸­åˆ›å»ºçš„é‡å¤å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨[é»˜è®¤å®¢æˆ·ç«¯](https://gitlab.com/gitlab-org/gitlab/blob/master/app/assets/javascripts/lib/graphql.js) . è¿™å°†ä½¿ç”¨æ­£ç¡®çš„ URL è®¾ç½® Apollo å®¢æˆ·ç«¯ï¼Œå¹¶è®¾ç½® CSRF æ ‡å¤´.

é»˜è®¤å®¢æˆ·ç«¯æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š `resolvers`å’Œ`config` .

*   åˆ›å»º`resolvers`å‚æ•°ä»¥æ¥å—ç”¨äº[æœ¬åœ°çŠ¶æ€ç®¡ç†](#local-state-with-apollo)æŸ¥è¯¢å’Œçªå˜çš„ resolvers å¯¹è±¡
*   `config`å‚æ•°é‡‡ç”¨é…ç½®è®¾ç½®çš„å¯¹è±¡ï¼š
    *   `cacheConfig`å­—æ®µæ¥å—è®¾ç½®çš„å¯é€‰å¯¹è±¡ä»¥[è‡ªå®šä¹‰ Apollo ç¼“å­˜](https://www.apollographql.com/docs/react/caching/cache-configuration/#configuring-the-cache)
    *   `baseUrl`å…è®¸æˆ‘ä»¬ä¼ é€’ä¸ä¸»ç«¯ç‚¹ä¸åŒçš„ GraphQL ç«¯ç‚¹çš„ URLï¼ˆå³`${gon.relative_url_root}/api/graphql` ï¼‰
    *   `assumeImmutableResults` ï¼ˆé»˜è®¤è®¾ç½®ä¸º`false` ï¼‰-æ­¤è®¾ç½®ä¸º`true` ï¼Œå°†å‡å®šæ›´æ–° Apollo Cache æ—¶çš„æ¯ä¸ªæ“ä½œéƒ½æ˜¯ä¸å¯å˜çš„. å®ƒè¿˜å°†`freezeResults`è®¾ç½®ä¸º`true` ï¼Œå› æ­¤ä»»ä½•å°è¯•`freezeResults` Apollo Cache çš„å°è¯•éƒ½ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­å¼•å‘æ§åˆ¶å°è­¦å‘Š. åœ¨å°†æ­¤é€‰é¡¹è®¾ç½®ä¸º`true`ä¹‹å‰ï¼Œè¯·ç¡®ä¿åœ¨ç¼“å­˜æ›´æ–°æ“ä½œä¸­éµå¾ªä¸å˜æ€§æ¨¡å¼.

## GraphQL Queries[](#graphql-queries "Permalink")

ä¸ºäº†åœ¨è¿è¡Œæ—¶ä¿å­˜æŸ¥è¯¢ç¼–è¯‘ï¼Œwebpack å¯ä»¥ç›´æ¥å¯¼å…¥`.graphql`æ–‡ä»¶. è¿™ä½¿ webpack å¯ä»¥åœ¨ç¼–è¯‘æ—¶å¯¹æŸ¥è¯¢è¿›è¡Œé¢„å¤„ç†ï¼Œè€Œä¸æ˜¯ç”±å®¢æˆ·ç«¯è¿›è¡ŒæŸ¥è¯¢çš„ç¼–è¯‘.

ä¸ºäº†å°†æŸ¥è¯¢ä¸çªå˜å’Œç‰‡æ®µåŒºåˆ†å¼€æ¥ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹å‘½åçº¦å®šï¼š

*   `all_users.query.graphql`ç”¨äºæŸ¥è¯¢ï¼›
*   `add_user.mutation.graphql`è¿›è¡Œçªå˜ï¼›
*   ç‰‡æ®µçš„`basic_user.fragment.graphql` .

### Fragments[](#fragments "Permalink")

[ç‰‡æ®µ](https://s0graphql0org.icopy.site/learn/queries/)æ˜¯ä½¿å¤æ‚çš„ GraphQL æŸ¥è¯¢æ›´å…·å¯è¯»æ€§å’Œå¯é‡ç”¨æ€§çš„ä¸€ç§æ–¹å¼. è¿™æ˜¯ GraphQL ç‰‡æ®µçš„ç¤ºä¾‹ï¼š

```
fragment DesignListItem on Design {
  id
  image
  event
  filename
  notesCount
} 
```

ç‰‡æ®µå¯ä»¥å­˜å‚¨åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å¯¼å…¥å¹¶ç”¨äºæŸ¥è¯¢ï¼Œçªå˜æˆ–å…¶ä»–ç‰‡æ®µ.

```
#import "./design_list.fragment.graphql"
#import "./diff_refs.fragment.graphql"

fragment DesignItem on Design {
  ...DesignListItem
  fullPath
  diffRefs {
    ...DesignDiffRefs
  }
} 
```

æœ‰å…³ç‰‡æ®µçš„æ›´å¤šä¿¡æ¯ï¼š [GraphQL Docs](https://s0graphql0org.icopy.site/learn/queries/)

## Usage in Vue[](#usage-in-vue "Permalink")

è¦ä½¿ç”¨ Vue Apolloï¼Œè¯·å¯¼å…¥[Vue Apollo](https://github.com/vuejs/vue-apollo)æ’ä»¶ä»¥åŠé»˜è®¤å®¢æˆ·ç«¯. è¿™åº”è¯¥åœ¨å®‰è£… Vue åº”ç”¨ç¨‹åºçš„åŒä¸€æ—¶é—´åˆ›å»º.

```
import Vue from 'vue';
import VueApollo from 'vue-apollo';
import createDefaultClient from '~/lib/graphql';
Vue.use(VueApollo);

const apolloProvider = new VueApollo({
  defaultClient: createDefaultClient(),
});

new Vue({
  ...,
  apolloProvider,
  ...
}); 
```

åœ¨[Vue Apollo æ–‡æ¡£ä¸­](https://vue-apollo.netlify.app/guide/)é˜…è¯»æœ‰å…³[Vue Apollo çš„](https://github.com/vuejs/vue-apollo)æ›´å¤šä¿¡æ¯.

### Local state with Apollo[](#local-state-with-apollo "Permalink")

åˆ›å»ºé»˜è®¤å®¢æˆ·ç«¯æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥ resolvers å¯¹è±¡æ¥ä½¿ç”¨ Apollo ç®¡ç†åº”ç”¨ç¨‹åºçŠ¶æ€. è®¾ç½®é»˜è®¤å®¢æˆ·ç«¯åï¼Œå¯ä»¥é€šè¿‡å†™å…¥ç¼“å­˜æ¥è®¾ç½®é»˜è®¤çŠ¶æ€.

```
import Vue from 'vue';
import VueApollo from 'vue-apollo';
import createDefaultClient from '~/lib/graphql';
Vue.use(VueApollo);

const defaultClient = createDefaultClient({
  resolvers: {}
});

defaultClient.cache.writeData({
  data: {
    user: {
      name: 'John',
      surname: 'Doe',
      age: 30
    },
  },
});

const apolloProvider = new VueApollo({
  defaultClient,
}); 
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`@client` Apollo æŒ‡ä»¤æŸ¥è¯¢æœ¬åœ°æ•°æ®ï¼š

```
// user.query.graphql

query User {
  user @client {
    name
    surname
    age
  }
} 
```

é™¤äº†åˆ›å»ºæœ¬åœ°æ•°æ®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨`@client`å­—æ®µæ‰©å±•ç°æœ‰çš„ GraphQL ç±»å‹. å½“æˆ‘ä»¬éœ€è¦ä¸ºå°šæœªæ·»åŠ åˆ° GraphQL API ä¸­çš„å­—æ®µæ¨¡æ‹Ÿ API å“åº”æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨.

#### Mocking API response with local Apollo cache[](#mocking-api-response-with-local-apollo-cache "Permalink")

å½“æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°æ¨¡æ‹ŸæŸäº› GraphQL API å“åº”ï¼ŒæŸ¥è¯¢æˆ–å˜å¼‚æ—¶ï¼ˆä¾‹å¦‚ï¼Œå½“å®ƒä»¬ä»æœªæ·»åŠ åˆ°æˆ‘ä»¬çš„å®é™… API ä¸­æ—¶ï¼‰ï¼Œä½¿ç”¨æœ¬åœ° Apollo ç¼“å­˜éå¸¸æ–¹ä¾¿.

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨äº†æœ‰å…³`DesignVersion`çš„[ç‰‡æ®µ](#fragments) ï¼š

```
fragment VersionListItem on DesignVersion {
  id
  sha
} 
```

æˆ‘ä»¬è¿˜éœ€è¦è·å–ç‰ˆæœ¬ä½œè€…å’Œ'created at'å±æ€§ï¼Œä»¥åœ¨ç‰ˆæœ¬ä¸‹æ‹‰åˆ—è¡¨ä¸­æ˜¾ç¤ºå®ƒä»¬ï¼Œä½†è¿™äº›æ›´æ”¹ä»æœªåœ¨æˆ‘ä»¬çš„ API ä¸­å®ç°. æˆ‘ä»¬å¯ä»¥æ›´æ”¹ç°æœ‰ç‰‡æ®µï¼Œä»¥é’ˆå¯¹è¿™äº›æ–°å­—æ®µè·å¾—æ¨¡æ‹Ÿçš„å“åº”ï¼š

```
fragment VersionListItem on DesignVersion {
  id
  sha
  author @client {
    avatarUrl
    name
  }
  createdAt @client
} 
```

ç°åœ¨ï¼ŒApollo å°†å°è¯•ä¸ºæ¯ä¸ªæ ‡æœ‰`@client`æŒ‡ä»¤çš„å­—æ®µæŸ¥æ‰¾*è§£æå™¨* . è®©æˆ‘ä»¬ä¸º`DesignVersion`ç±»å‹åˆ›å»ºä¸€ä¸ªè§£æå™¨ï¼ˆä¸ºä»€ä¹ˆè¦ä½¿ç”¨`DesignVersion` ï¼Ÿï¼Œå› ä¸ºæˆ‘ä»¬çš„ç‰‡æ®µæ˜¯åœ¨è¿™ç§ç±»å‹ä¸Šåˆ›å»ºçš„ï¼‰.

```
// resolvers.js

const resolvers = {
  DesignVersion: {
    author: () => ({
      avatarUrl:
        'https://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=80&d=identicon',
      name: 'Administrator',
      __typename: 'User',
    }),
    createdAt: () => '2019-11-13T16:08:11Z',
  },
};

export default resolvers; 
```

æˆ‘ä»¬éœ€è¦å°†è§£æå™¨å¯¹è±¡ä¼ é€’ç»™æˆ‘ä»¬ç°æœ‰çš„ Apollo Clientï¼š

```
// graphql.js

import createDefaultClient from '~/lib/graphql';
import resolvers from './graphql/resolvers';

const defaultClient = createDefaultClient(
  {},
  resolvers,
); 
```

ç°åœ¨ï¼Œæ¯æ¬¡å°è¯•è·å–ç‰ˆæœ¬æ—¶ï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯éƒ½ä¼šä»è¿œç¨‹ API ç«¯ç‚¹è·å–`id`å’Œ`sha` ï¼Œå¹¶å°†æˆ‘ä»¬çš„ç¡¬ç¼–ç å€¼åˆ†é…ç»™`author`å’Œ`createdAt`ç‰ˆæœ¬å±æ€§. æœ‰äº†è¿™äº›æ•°æ®ï¼Œå‰ç«¯å¼€å‘äººå‘˜å°±å¯ä»¥åœ¨ UI éƒ¨ä»¶ä¸Šå·¥ä½œï¼Œè€Œä¸ä¼šè¢«åç«¯é˜»å¡. å°†å®é™…å“åº”æ·»åŠ åˆ° API åï¼Œå¯ä»¥å¿«é€Ÿåˆ é™¤è‡ªå®šä¹‰æœ¬åœ°è§£æå™¨ï¼Œå¹¶ä¸”å¯¹æŸ¥è¯¢/ç‰‡æ®µçš„å”¯ä¸€æ›´æ”¹æ˜¯`@client`æŒ‡ä»¤åˆ é™¤.

åœ¨[Vue Apollo æ–‡æ¡£ä¸­](https://vue-apollo.netlify.app/guide/local-state.html#local-state)é˜…è¯»æœ‰å…³ä½¿ç”¨ Apollo è¿›è¡Œæœ¬åœ°çŠ¶æ€ç®¡ç†çš„æ›´å¤šä¿¡æ¯.

### Using with Vuex[](#using-with-vuex "Permalink")

When Apollo Client is used within Vuex and fetched data is stored in the Vuex store, there is no need in keeping Apollo Client cache enabled. Otherwise we would have data from the API stored in two places - Vuex store and Apollo Client cache. More to say, with Apolloâ€™s default settings, a subsequent fetch from the GraphQL API could result in fetching data from Apollo cache (in the case where we have the same query and variables). To prevent this behavior, we need to disable Apollo Client cache passing a valid `fetchPolicy` option to its constructor:

```
import fetchPolicies from '~/graphql_shared/fetch_policy_constants';

export const gqClient = createGqClient(
  {},
  {
    fetchPolicy: fetchPolicies.NO_CACHE,
  },
); 
```

### Feature flags in queries[](#feature-flags-in-queries "Permalink")

æœ‰æ—¶åœ¨ GraphQL æŸ¥è¯¢ä¸­çš„åŠŸèƒ½æ ‡å¿—åé¢æ”¾ç½®ä¸€ä¸ªå®ä½“å¯èƒ½ä¼šå¾ˆæœ‰ç”¨. ä¾‹å¦‚ï¼Œå½“å¤„ç†åç«¯å·²ç»åˆå¹¶ä½†å‰ç«¯æ²¡æœ‰åˆå¹¶çš„åŠŸèƒ½æ—¶ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°† GraphQL å®ä½“æ”¾åœ¨åŠŸèƒ½æ ‡è®°åé¢ï¼Œä»¥å…è®¸åˆ›å»ºå’Œåˆå¹¶è¾ƒå°çš„åˆå¹¶è¯·æ±‚.

ä¸ºæ­¤ï¼Œ `if`è¯­å¥é€šè¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`@include`æŒ‡ä»¤æ’é™¤å®ä½“.

```
query  getAuthorData($authorNameEnabled:  Boolean  =  false)  {  username  name  @include(if:  $authorNameEnabled)  } 
```

ç„¶åï¼Œåœ¨å¯¹æŸ¥è¯¢çš„ Vueï¼ˆæˆ– JavaScriptï¼‰è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’åŠŸèƒ½æ ‡è®°. æ­¤åŠŸèƒ½æ ‡å¿—å°†éœ€è¦å·²ç»æ­£ç¡®è®¾ç½®. æœ‰å…³æ­£ç¡®æ–¹æ³•ï¼Œè¯·å‚é˜…[åŠŸèƒ½éƒ¨ä»¶æ ‡å¿—æ–‡æ¡£](../feature_flags/development.html) .

```
export default {
  apollo: {
    user: {
      query: QUERY_IMPORT,
      variables() {
        return {
          authorNameEnabled: gon?.features?.authorNameEnabled,
        };
      },
    }
  },
}; 
```

### Manually triggering queries[](#manually-triggering-queries "Permalink")

åˆ›å»ºç»„ä»¶æ—¶ï¼Œå°†è‡ªåŠ¨å¯¹ç»„ä»¶çš„`apollo`å±æ€§è¿›è¡ŒæŸ¥è¯¢. æŸäº›ç»„ä»¶åè€Œå¸Œæœ›æŒ‰éœ€å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œå¸¦æœ‰å»¶è¿ŸåŠ è½½é¡¹çš„ä¸‹æ‹‰åˆ—è¡¨.

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

1.  Use the `skip` property

```
export default {
  apollo: {
    user: {
      query: QUERY_IMPORT,
      skip() {
        // only make the query when dropdown is open
        return !this.isOpen;
      },
    }
  },
}; 
```

1.  Using `addSmartQuery`

æ‚¨å¯ä»¥åœ¨æ‚¨çš„æ–¹æ³•ä¸­æ‰‹åŠ¨åˆ›å»ºæ™ºèƒ½æŸ¥è¯¢.

```
handleClick() {
  this.$apollo.addSmartQuery('user', {
    // this takes the same values as you'd have in the `apollo` section
    query: QUERY_IMPORT,
  }),
}; 
```

### Working with pagination[](#working-with-pagination "Permalink")

GitLab çš„ GraphQL API å¯¹è¿æ¥ç±»å‹ä½¿ç”¨[ä¸­ç»§æ ·å¼çš„æ¸¸æ ‡åˆ†é¡µ](https://www.apollographql.com/docs/react/data/pagination/#cursor-based) . è¿™æ„å‘³ç€ä½¿ç”¨"æ¸¸æ ‡"æ¥è·Ÿè¸ªåº”ä»ä¸­æå–ä¸‹ä¸€é¡¹çš„æ•°æ®é›†ä¸­çš„ä½ç½®. [GraphQL Ruby Connection Concepts](https://graphql-ruby.org/pagination/connection_concepts.html)æ˜¯å¯¹è¿æ¥çš„è‰¯å¥½æ¦‚è¿°å’Œä»‹ç».

æ¯ä¸ªè¿æ¥ç±»å‹ï¼ˆä¾‹å¦‚`DesignConnection`å’Œ`DiscussionConnection` ï¼‰éƒ½æœ‰ä¸€ä¸ªå­—æ®µ`pageInfo` ï¼Œå…¶ä¸­åŒ…å«åˆ†é¡µæ‰€éœ€çš„ä¿¡æ¯ï¼š

```
pageInfo {
  endCursor
  hasNextPage
  hasPreviousPage
  startCursor
} 
```

Here:

*   `startCursor`å’Œ`endCursor`æ˜¾ç¤ºç¬¬ä¸€é¡¹å’Œæœ€åä¸€é¡¹çš„å…‰æ ‡.
*   `hasPreviousPage`å’Œ`hasNextPage`å…è®¸æˆ‘ä»¬æ£€æŸ¥å½“å‰é¡µé¢ä¹‹å‰æˆ–ä¹‹åæ˜¯å¦è¿˜æœ‰æ›´å¤šé¡µé¢å¯ç”¨.

å½“æˆ‘ä»¬ä»¥è¿æ¥ç±»å‹è·å–æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥`before`å‚æ•°çš„`after`æˆ–`before`ä¼ é€’æ¸¸æ ‡ï¼Œä»¥æŒ‡ç¤ºåˆ†é¡µçš„èµ·ç‚¹æˆ–ç»ˆç‚¹. åº”è¯¥åˆ†åˆ«åœ¨å®ƒä»¬çš„åè·Ÿ`first`æˆ–`last`å‚æ•°ï¼Œä»¥æŒ‡ç¤ºæˆ‘ä»¬è¦åœ¨ç»™å®šç«¯ç‚¹ä¹‹åæˆ–ä¹‹å‰è·å–*å¤šå°‘ä¸ª*é¡¹ç›®.

ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨å…‰æ ‡ä¹‹åè·å– 10 ä¸ªè®¾è®¡ï¼š

```
query {
  project(fullPath: "root/my-project") {
    id
    issue(iid: "42") {
      designCollection {
        designs(atVersion: null, after: "Ihwffmde0i", first: 10) {
          edges {
            node {
              id
            }
          }
        }
      }
    }
  }
} 
```

#### Using `fetchMore` method in components[](#using-fetchmore-method-in-components "Permalink")

è¿›è¡Œåˆå§‹æŠ“å–æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›ä»å¤´å¼€å§‹è¿›è¡Œåˆ†é¡µ. åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

*   è·³è¿‡ä¼ é€’å…‰æ ‡.
*   å°†`null`æ˜ç¡®ä¼ é€’ç»™`after` .

æå–æ•°æ®åï¼Œæˆ‘ä»¬åº”è¯¥ä¿å­˜ä¸€ä¸ª`pageInfo`å¯¹è±¡. å‡è®¾æˆ‘ä»¬å°†å…¶å­˜å‚¨åˆ° Vue ç»„ä»¶`data` ï¼š

```
data() {
  return {
    pageInfo: null,
  }
},
apollo: {
  designs: {
    query: projectQuery,
    variables() {
      return {
        // rest of design variables
        ...
        first: 10,
      };
    },
    result(res) {
      this.pageInfo = res.data?.project?.issue?.designCollection?.designs?.pageInfo;
    },
  },
}, 
```

å½“æˆ‘ä»¬æƒ³ç§»è‡³ä¸‹ä¸€é¡µæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ Apollo `fetchMore`æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼ é€’ä¸€ä¸ªæ–°çš„æ¸¸æ ‡ï¼ˆä»¥åŠå¯é€‰çš„æ–°å˜é‡ï¼‰. åœ¨`updateQuery`æŒ‚é’©ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è·å–ä¸‹ä¸€é¡µä¹‹åè¿”å›è¦åœ¨ Apollo ç¼“å­˜ä¸­çœ‹åˆ°çš„ç»“æœ.

```
fetchNextPage() {
  // as a first step, we're checking if we have more pages to move forward
  if (this.pageInfo?.hasNextPage) {
    this.$apollo.queries.designs.fetchMore({
      variables: {
        // rest of design variables
        ...
        first: 10,
        after: this.pageInfo?.endCursor,
      },
      updateQuery(previousResult, { fetchMoreResult }) {
        // here we can implement the logic of adding new designs to fetched one (for example, if we use infinite scroll)
        // or replacing old result with the new one if we use numbered pages

        const newDesigns = fetchMoreResult.project.issue.designCollection.designs;
        previousResult.project.issue.designCollection.designs.push(...newDesigns)

        return previousResult;
      },
    });
  }
} 
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸å¿…å†ä¿å­˜`pageInfo`äº†ï¼› `fetchMore`è§¦å‘æŸ¥è¯¢`result`æŒ‚é’©.

### Testing[](#testing "Permalink")

#### Mocking response as component data[](#mocking-response-as-component-data "Permalink")

ä½¿ç”¨[Vue æµ‹è¯•å·¥å…·](https://vue-test-utils.vuejs.org/) ï¼Œå¯ä»¥è½»æ¾å¿«é€Ÿåœ°æµ‹è¯•è·å– GraphQL æŸ¥è¯¢çš„ç»„ä»¶. æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨`shallowMount` ï¼Œç„¶ååœ¨ç»„ä»¶ä¸Šè®¾ç½®æ•°æ®

```
it('tests apollo component', () => {
  const vm = shallowMount(App);

  vm.setData({
    ...mock data
  });
}); 
```

#### Testing loading state[](#testing-loading-state "Permalink")

å¦‚æœéœ€è¦æµ‹è¯•å½“ GraphQL API çš„ç»“æœä»åœ¨åŠ è½½æ—¶ç»„ä»¶çš„å‘ˆç°æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠ è½½çŠ¶æ€æ¨¡æ‹Ÿåˆ°ç›¸åº”çš„ Apollo æŸ¥è¯¢/çªå˜ä¸­ï¼š

```
 function createComponent({
    loading = false,
  } = {}) {
    const $apollo = {
      queries: {
        designs: {
          loading,
        },
    };

    wrapper = shallowMount(Index, {
      sync: false,
      mocks: { $apollo }
    });
  }

  it('renders loading icon', () => {
  createComponent({ loading: true });

  expect(wrapper.element).toMatchSnapshot();
}) 
```

#### Testing Apollo components[](#testing-apollo-components "Permalink")

å¦‚æœæˆ‘ä»¬åœ¨ç»„ä»¶ä¸­ä½¿ç”¨`ApolloQuery`æˆ–`ApolloMutation` ï¼Œä¸ºäº†æµ‹è¯•å…¶åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ·»åŠ ä¸€ä¸ªå­˜æ ¹ï¼š

```
import { ApolloMutation } from 'vue-apollo';

function createComponent(props = {}) {
  wrapper = shallowMount(MyComponent, {
    sync: false,
    propsData: {
      ...props,
    },
    stubs: {
      ApolloMutation,
    },
  });
} 
```

`ApolloMutation`ç»„ä»¶é€šè¿‡ä½œç”¨åŸŸæ’æ§½å…¬å¼€äº†`mutate`æ–¹æ³•. å¦‚æœè¦æµ‹è¯•æ­¤æ–¹æ³•ï¼Œåˆ™éœ€è¦å°†å…¶æ·»åŠ åˆ°æ¨¡æ‹Ÿä¸­ï¼š

```
const mutate = jest.fn().mockResolvedValue();
const $apollo = {
  mutate,
};

function createComponent(props = {}) {
  wrapper = shallowMount(MyComponent, {
    sync: false,
    propsData: {
      ...props,
    },
    stubs: {
      ApolloMutation,
    },
    mocks: {
      $apollo:
    }
  });
} 
```

ç„¶åæˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„å˜é‡è°ƒç”¨äº†`mutate` ï¼š

```
const mutationVariables = {
  mutation: createNoteMutation,
  update: expect.anything(),
  variables: {
    input: {
      noteableId: 'noteable-id',
      body: 'test',
      discussionId: '0',
    },
  },
};

it('calls mutation on submitting form ', () => {
  createComponent()
  findReplyForm().vm.$emit('submitForm');

  expect(mutate).toHaveBeenCalledWith(mutationVariables);
}); 
```

## Handling errors[](#handling-errors "Permalink")

ç›®å‰ï¼ŒGitLab çš„ GraphQL çªå˜å…·æœ‰ä¸¤ç§ä¸åŒçš„é”™è¯¯æ¨¡å¼ï¼š [é¡¶çº§](#top-level-errors)å’Œ[æ•°æ®é”™è¯¯](#errors-as-data) .

åˆ©ç”¨ GraphQL çªå˜æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘å¤„ç†**è¿™ä¸¤ç§é”™è¯¯æ¨¡å¼ï¼Œ**ä»¥ç¡®ä¿ç”¨æˆ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶èƒ½å¤Ÿæ”¶åˆ°é€‚å½“çš„åé¦ˆ.

### Top-level errors[](#top-level-errors "Permalink")

è¿™äº›é”™è¯¯ä½äº GraphQL å“åº”çš„"é¡¶çº§". è¿™äº›æ˜¯ä¸å¯æ¢å¤çš„é”™è¯¯ï¼ŒåŒ…æ‹¬å‚æ•°é”™è¯¯å’Œè¯­æ³•é”™è¯¯ï¼Œå› æ­¤ä¸åº”ç›´æ¥å‘ˆç°ç»™ç”¨æˆ·.

#### Handling top-level errors[](#handling-top-level-errors "Permalink")

Apollo æ„è¯†åˆ°é¡¶çº§é”™è¯¯ï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨ Apollo çš„å„ç§é”™è¯¯å¤„ç†æœºåˆ¶æ¥å¤„ç†è¿™äº›é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨[`mutate`](https://www.apollographql.com/docs/react/api/apollo-client/#ApolloClient.mutate)æ–¹æ³•ä¹‹åå¤„ç† Promise æ‹’ç»ï¼Œæˆ–å¤„ç†ä»[`ApolloMutation`](https://apollo.vuejs.org/api/apollo-mutation.html#events)ç»„ä»¶å‘å‡ºçš„`error`äº‹ä»¶ï¼‰.

ç”±äºè¿™äº›é”™è¯¯ä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ï¼Œå› æ­¤åº”åœ¨å®¢æˆ·ç«¯å®šä¹‰é¡¶çº§é”™è¯¯çš„é”™è¯¯æ¶ˆæ¯.

### Errors-as-data[](#errors-as-data "Permalink")

è¿™äº›é”™è¯¯åµŒå¥—åœ¨ GraphQL å“åº”çš„`data`å¯¹è±¡ä¸­. è¿™äº›æ˜¯å¯æ¢å¤çš„é”™è¯¯ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥å‘ç”¨æˆ·æ˜¾ç¤º.

#### Handling errors-as-data[](#handling-errors-as-data "Permalink")

é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»å‘æˆ‘ä»¬çš„å˜å¼‚å¯¹è±¡æ·»åŠ `errors` ï¼š

```
mutation createNoteMutation($input: String!) {
  createNoteMutation(input: $input) {
    note {
      id
+     errors
    }
  } 
```

ç°åœ¨ï¼Œå½“æˆ‘ä»¬æäº¤æ­¤çªå˜å¹¶å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå“åº”ä¸­å°†åŒ…å«`errors`ä¾›æˆ‘ä»¬å¤„ç†ï¼š

```
{
  data: {
    mutationName: {
      errors: ["Sorry, we were not able to update the note."]
    }
  }
} 
```

å¤„ç†æ•°æ®é”™è¯¯æ—¶ï¼Œè¯·æ ¹æ®æ‚¨çš„æœ€ä½³åˆ¤æ–­æ¥ç¡®å®šæ˜¯å°†é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºåœ¨å“åº”ä¸­ï¼Œè¿˜æ˜¯å°†å¦ä¸€æ¡å®¢æˆ·ç«¯å®šä¹‰çš„æ¶ˆæ¯æ˜¾ç¤ºç»™ç”¨æˆ·.

## Usage outside of Vue[](#usage-outside-of-vue "Permalink")

é€šè¿‡ç›´æ¥å¯¼å…¥é»˜è®¤å®¢æˆ·ç«¯å¹¶å°†å…¶ä¸æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨ï¼Œè¿˜å¯ä»¥åœ¨ Vue ä¹‹å¤–ä½¿ç”¨ GraphQL.

```
import createDefaultClient from '~/lib/graphql';
import query from './query.graphql';

const defaultClient = createDefaultClient();

defaultClient.query({ query })
  .then(result => console.log(result)); 
```

[ä½¿ç”¨ Vuex æ—¶](#Using-with-Vuex) ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ç¦ç”¨ç¼“å­˜ï¼š

*   æ•°æ®æ­£åœ¨å…¶ä»–åœ°æ–¹ç¼“å­˜
*   å¦‚æœæ•°æ®æ­£åœ¨å…¶ä»–åœ°æ–¹ç¼“å­˜ï¼Œæˆ–è€…å¯¹äºç»™å®šçš„ç”¨ä¾‹å®Œå…¨ä¸éœ€è¦ï¼Œåˆ™ç”¨ä¾‹ä¸éœ€è¦ç¼“å­˜.

```
import createDefaultClient from '~/lib/graphql';
import fetchPolicies from '~/graphql_shared/fetch_policy_constants';

const defaultClient = createDefaultClient(
  {},
  {
    fetchPolicy: fetchPolicies.NO_CACHE,
  },
); 
```